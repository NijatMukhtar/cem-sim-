<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>CEM — DEMO</title>
<style>
  :root{
    
    --ring: 560px;
    --trackInset: 72px;                                  
    --radius: calc(var(--ring)/2 - var(--trackInset));   

    --coil-w: 56px; --coil-h: 28px;

    --disc: 310px;                 
    --pieceW: 44px;                
    --pieceH: 22px;
    --pieceOffset: 12px;           
    --pieceAngle: 90deg;          

  
    --bg:#0a0b10; --panel:#0e1219; --border:#1a2130;
    --text:#e9eef6; --muted:#9aa6b2; --glow:#57ff9a;
    --pieceColor:#dfe6f2;         
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    background: radial-gradient(1100px 800px at 20% -10%, #111420, var(--bg) 60%);
    color:var(--text); font:14px/1.5 Inter,system-ui,-apple-system,Segoe UI,Arial;
    display:grid; place-items:center; padding:20px;
  }
  .stage{ width:min(1140px,96vw); display:grid; grid-template-columns: 1fr 340px; gap:28px; align-items:center; }
  @media (max-width:1020px){ .stage{grid-template-columns:1fr} }

 
  .arena{
    position:relative; width:var(--ring); height:var(--ring); margin:auto; border-radius:50%;
    background: radial-gradient(circle at 50% 50%, #0e1219 40%, #0c1119 41%), conic-gradient(#0f1521, #0f1724 40%, #101826);
    box-shadow: inset 0 0 60px #000a;
  }
  .ring-outer{ position:absolute; inset:10px; border-radius:50%; border:10px solid #ffffff14; box-shadow:0 0 0 1px #fff1 inset; opacity:.35; }
  .ring-track{ position:absolute; inset:var(--trackInset); border-radius:50%; border:10px solid #8bd0ff26; box-shadow:0 0 0 1px #ffffff10 inset; }
  .ring-dash{ position:absolute; inset:0; border-radius:50%; border:1px dashed #233042; opacity:.4 }

  
  .disc-wrap{
    position:absolute; left:50%; top:50%;
    transform: translate(-50%,-50%) rotate(0deg); 
    will-change: transform;
  }
  .disc{
    width:var(--disc); height:var(--disc); border-radius:50%;
    background: radial-gradient(circle at 35% 30%, #eef3fa 0%, #dde3ee 35%, #c6cfdb 65%, #b0bac8 100%);
    box-shadow: inset 8px -10px 18px #9aa3b1b0, inset -10px 12px 24px #ffffffaa, 0 16px 46px #0009;
  }
  .hub{
    position:absolute; left:50%; top:50%; transform:translate(-50%,-50%);
    width:74px; height:74px; border-radius:50%;
    background: radial-gradient(circle at 35% 35%, #808a98, #566171 60%, #465160);
    box-shadow: inset 0 0 0 6px #cdd3dc55, 0 8px 16px #0009;
  }
  .axle{ position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); width:16px; height:16px; border-radius:50%; background:#2a333f; box-shadow: inset 0 0 0 3px #111820; }

  
  .rotor-piece{
    position:absolute; left:50%; top:50%;
    width:var(--pieceW); height:var(--pieceH);
    transform: translate(-50%,-50%)
               rotate(var(--pieceAngle))
               translateY(calc(-1 * (var(--disc)/2 + var(--pieceOffset))));
    background: var(--pieceColor);
    border-radius: 6px;
    box-shadow: 0 4px 14px #0008, 0 0 0 1px #bfc8d4 inset;
  }

  
  .coil{
    position:absolute; left:0; top:0; width:var(--coil-w); height:var(--coil-h);
    border-radius:8px; overflow:hidden; transform: translate(-50%,-50%) rotate(var(--rot));
    filter:brightness(.9) saturate(.95); box-shadow: 0 3px 12px #0008, 0 8px 24px #0005;
  }
  .coil .body{ position:absolute; inset:0; background:linear-gradient(180deg,#bd7b2a 0%, #a45d1b 50%, #bd7b2a 100%); }
  .coil .capL, .coil .capR{ position:absolute; top:0; width:10px; height:100%; background:#5f6b77; filter:brightness(1.1); }
  .coil .capL{ left:0;  box-shadow: inset -2px 0 3px #0005 }
  .coil .capR{ right:0; box-shadow: inset  2px 0 3px #0005 }
  .coil.active{ box-shadow: 0 3px 12px #0008, 0 0 30px var(--glow); filter:brightness(1) }
  .coil.active::after{ content:""; position:absolute; right:-12px; top:50%; width:12px; height:12px; margin-top:-6px; border-radius:50%; background:var(--glow); box-shadow:0 0 16px var(--glow); }

  
  .panel{ background:var(--panel); border:1px solid var(--border); border-radius:14px; padding:14px; box-shadow:0 12px 36px #0007; }
  .panel h3{margin:4px 0 8px; font-size:15px}
  .row{display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin:8px 0}
  button,select,input{ background:#0c1119; color:#e9eef6; border:1px solid var(--border);
    border-radius:10px; padding:8px 12px; font:600 13px/1 Inter,system-ui,Arial; }
  button{background:linear-gradient(180deg,#2b72ff,#1f59d1); border-color:#2a65e0; cursor:pointer}
  button.secondary{background:#121722}
  input[type="number"]{width:92px} input[type="text"]{width:100%}
  .stats{font:12px/1.6 ui-monospace,Menlo,Consolas; color:#cfe2ff; background:#09101a; border:1px solid #162033; border-radius:8px; padding:8px; margin-top:8px}
  .hint{font-size:12px;color:var(--muted);margin-top:6px}
</style>
</head>
<body>
<div class="stage">
  <div class="arena" id="arena">
    <div class="ring-outer"></div>
    <div class="ring-track"></div>
    <div class="ring-dash"></div>

    
    <div class="disc-wrap" id="discWrap">
      <div class="rotor-piece" id="piece"></div>
      <div class="disc"></div>
      <div class="hub"></div>
      <div class="axle"></div>
    </div>
  </div>

  <div class="panel">
    <h2>RUN</h2>
    <div class="row">
      <button id="btnStart">START</button>
      <button id="btnStop" class="secondary">STOP</button>
      <button id="btnReset" class="secondary">RESET</button>
    </div>

    <h3>Parameters</h3>
    <div class="row">
      <label>Number of EMs (N) <input type="number" id="inpN" min="1" max="64" value="4"></label>
      <label>Mode
        <select id="inpMode">
          <option value="1">Single</option>
          <option value="2" selected>Paired (neighbor)</option>
        </select>
      </label>
      <label>Direction
        <select id="inpDir">
          <option value="1" selected>CW (+)</option>
          <option value="-1">CCW (−)</option>
        </select>
      </label>
    </div>
    <div class="row">
      <label>Speed (RPM) <input type="number" id="inpRPM" value="50"></label>
      <label>Step (ms) <input type="number" id="inpStep" value="10"></label>
      <label>Overlap (°) <input type="number" id="inpOverlap" value="20"></label>
      <label>Phase offset (°) <input type="number" id="inpPhase" value="0"></label>
    </div>
    <label>Start angles (°, comma-separated)
      <input type="text" id="inpAngles" value="0,90,180,270">
    </label>
    <div class="row" style="margin-top:6px">
      <button class="secondary" id="btn4x90">4×90°</button>
      <button class="secondary" id="btn6x60">6×60°</button>
      <button class="secondary" id="btn8x45">8×45°</button>
      <button class="secondary" id="btn12x30">12×30°</button>
    </div>

    <div class="stats" id="stats"> • t=0.000s • piece_angle=0.0° • rpm=50 </div>
    <div class="hint">The system energizes the electromagnet aligned with the rotor’s absolute angle. <em>Overlap</em> defines the dwell range (±overlap/2) around this position, while <em>phase offset</em> corrects timing errors between sensor and drive signals. In <em>Paired</em> mode, adjacent coils are co-energized to broaden the magnetic field and reduce torque ripple.
</div>
  </div>
</div>

<script>
const $ = id => document.getElementById(id);
const wrap360 = a => (a%360 + 360) % 360;
const clamp = (x,a,b)=> Math.max(a, Math.min(b, x));
const angDiff = (a,b)=> { let d = Math.abs(wrap360(a) - wrap360(b)); return d>180 ? 360-d : d; };


const arena = $("arena"), discWrap=$("discWrap"), stats=$("stats");
const inpN=$("inpN"), inpMode=$("inpMode"), inpDir=$("inpDir"),
      inpRPM=$("inpRPM"), inpStep=$("inpStep"), inpOverlap=$("inpOverlap"), inpPhase=$("inpPhase"),
      inpAngles=$("inpAngles");
const btnStart=$("btnStart"), btnStop=$("btnStop"), btnReset=$("btnReset");
const btn4x90=$("btn4x90"), btn6x60=$("btn6x60"), btn8x45=$("btn8x45"), btn12x30=$("btn12x30");


let N=4, mode=2, dir=1, rpm=300, stepMs=40, overlapDeg=20, phaseDeg=0;
let angles=[0,90,180,270];  
let t=0, ang=0, raf=null, last=0; 


function cssNum(el, name){ return parseFloat(getComputedStyle(el).getPropertyValue(name)); }
function trackRadius(){ const ring = cssNum(document.documentElement,'--ring'); const inset=cssNum(document.documentElement,'--trackInset'); return ring/2 - inset; }
function ringCenter(){ return { cx: arena.clientWidth/2, cy: arena.clientHeight/2 }; }


let coils=[];
function buildCoils(){
  coils.forEach(c=>c.el.remove()); coils=[];
  for(let i=0;i<N;i++){
    const el=document.createElement('div'); el.className='coil';
    const b=document.createElement('div'); b.className='body';
    const l=document.createElement('div'); l.className='capL';
    const r=document.createElement('div'); r.className='capR';
    el.append(b,l,r); arena.appendChild(el); coils.push({el});
  }
  placeCoils();
}
function placeCoils(){
  const r=trackRadius(); const {cx,cy}=ringCenter();
  for(let i=0;i<N;i++){
    const deg=wrap360(angles[i]);               
    const rad=(deg-90)*Math.PI/180;             
    const el=coils[i].el;
    el.style.left=(cx + r*Math.cos(rad))+"px";
    el.style.top =(cy + r*Math.sin(rad))+"px";
    el.style.setProperty('--rot', deg+'deg');
  }
}


function readUI(){
  N=clamp(parseInt(inpN.value||"4"),1,64);
  mode=parseInt(inpMode.value||"2"); dir=parseInt(inpDir.value||"1");
  rpm=parseFloat(inpRPM.value||"300"); stepMs=parseFloat(inpStep.value||"40");
  overlapDeg=parseFloat(inpOverlap.value||"20");
  phaseDeg  =parseFloat(inpPhase.value  ||"0");

  const arr=(inpAngles.value||"").split(",").map(s=>parseFloat(s.trim())).filter(v=>!Number.isNaN(v)).map(wrap360);
  if(arr.length===N) angles=arr; else { angles=[...Array(N)].map((_,i)=> i*(360/N)); inpAngles.value=angles.join(","); }

  if(coils.length!==N) buildCoils();
  placeCoils();
}


function activeByOverlap(pieceAbsAngle){
  const on=new Set();
  for(let i=0;i<N;i++){
    const diff = angDiff(pieceAbsAngle, angles[i]);
    if(diff <= overlapDeg/2){
      on.add(i);
      if(mode===2) on.add((i+1)%N);
    }
  }
  return [...on].sort((a,b)=>a-b);
}


function render(){
 
  discWrap.style.transform = `translate(-50%,-50%) rotate(${ang - 90}deg)`;

  
  const pieceAngleDeg = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--pieceAngle')) || 0;
  const pieceAbs = wrap360(ang + (pieceAngleDeg - 90) + phaseDeg);


  const act = activeByOverlap(pieceAbs);
  coils.forEach((c,i)=> c.el.classList.toggle('active', act.includes(i)));

  stats.textContent = `• t=${t.toFixed(3)}s • piece_angel=${pieceAbs.toFixed(1)}° • rpm=${rpm.toFixed(1)}`;
}


function loop(now){
  if(!last) last=now;
  let dt=(now-last)/1000, step=stepMs/1000;
  while(dt>=step){ t+=step; ang=wrap360(ang + 360*(rpm/60)*step*dir); dt-=step; }
  last=now - dt*1000; render(); raf=requestAnimationFrame(loop);
}


btnStart.onclick=()=>{ readUI(); if(!raf){ last=0; raf=requestAnimationFrame(loop);} };
btnStop.onclick =()=>{ if(raf){ cancelAnimationFrame(raf); raf=null; } };
btnReset.onclick=()=>{ if(raf){ cancelAnimationFrame(raf); raf=null; } t=0; ang=0; render(); };

btn4x90.onclick = ()=>{ inpN.value=4;  inpAngles.value="0,90,180,270"; readUI(); render(); };
btn6x60.onclick = ()=>{ inpN.value=6;  inpAngles.value="0,60,120,180,240,300"; readUI(); render(); };
btn8x45.onclick = ()=>{ inpN.value=8;  inpAngles.value="0,45,90,135,180,225,270,315"; readUI(); render(); };
btn12x30.onclick= ()=>{ inpN.value=12; inpAngles.value=Array.from({length:12},(_,i)=>i*30).join(","); readUI(); render(); };

window.addEventListener('resize', ()=>{ placeCoils(); });


buildCoils(); readUI(); render();
</script>
</body>
</html>
